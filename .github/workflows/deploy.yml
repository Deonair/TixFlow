name: TixFlow CI/CD Deployment

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: [self-hosted, Windows, X64]

    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4
      
      - name: 1b. Move Code to C:\TixFlow\ProjectRoot
        shell: powershell
        run: |
          New-Item -ItemType Directory -Path "C:\TixFlow\ProjectRoot" -ErrorAction SilentlyContinue | Out-Null
          Remove-Item -Path "C:\TixFlow\ProjectRoot\*" -Recurse -Force -ErrorAction SilentlyContinue
          Copy-Item -Path "${{ github.workspace }}\*" -Destination "C:\TixFlow\ProjectRoot" -Recurse -Force

      - name: 2. Set up Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: '25'

      - name: 2b. Resolve Node Path
        shell: powershell
        run: |
          $node = (Get-Command node).Source
          echo "NODE_PATH=$node" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: 3. Install Frontend Dependencies
        shell: powershell
        run: npm install
        working-directory: C:\TixFlow\ProjectRoot\my-app

      - name: 4. Build Frontend for Production
        shell: powershell
        run: npm run build
        working-directory: C:\TixFlow\ProjectRoot\my-app

      - name: 5. Stop Old Backend Server (Cruciaal voor herstart)
        shell: powershell
        run: |
          $pidFile = "C:\TixFlow\ProjectRoot\backend.pid"
          $backendPath = "C:\TixFlow\ProjectRoot\my-app\backend"

          # 1) Probeer eerst via PID-bestand te stoppen (meest betrouwbaar)
          if (Test-Path $pidFile) {
            try {
              $pid = Get-Content $pidFile | Select-Object -First 1
              if ($pid) {
                Stop-Process -Id $pid -Force -ErrorAction SilentlyContinue
                Remove-Item $pidFile -Force -ErrorAction SilentlyContinue
                Write-Host "Stopped backend by PID $pid"
              } else {
                Write-Host "PID file empty. Fallback to process scan."
              }
            } catch {
              Write-Host "Stop by PID failed, fallback to process scan."
            }
          }

          # 2) Fallback: vind gerichte Node-processen die in backend draaien en stop ze
          try {
            $nodeProcs = Get-CimInstance Win32_Process | Where-Object { $_.Name -match '^node(\.exe)?$' -and $_.CommandLine -like "*${backendPath}*" }
            if ($nodeProcs) {
              foreach ($p in $nodeProcs) {
                try { Stop-Process -Id $p.ProcessId -Force -ErrorAction SilentlyContinue } catch {}
              }
              Write-Host "Stopped $($nodeProcs.Count) node backend process(es)."
            } else {
              Write-Host "No node backend process found."
            }
          } catch {
            Write-Host "Process scan failed; continuing without stopping."
          }

      - name: 6. Copy Frontend Files to IIS Root
        shell: powershell
        run: |
          New-Item -ItemType Directory -Path "C:\TixFlow\wwwroot" -ErrorAction SilentlyContinue | Out-Null
          Remove-Item -Path "C:\TixFlow\wwwroot\*" -Recurse -Force -ErrorAction SilentlyContinue
          Copy-Item -Path "C:\TixFlow\ProjectRoot\my-app\dist\*" -Destination "C:\TixFlow\wwwroot" -Recurse -Force

      - name: 6c. Ensure web.config for IIS proxy
        shell: powershell
        run: |
          Copy-Item -Path "C:\TixFlow\ProjectRoot\my-app\public\web.config" -Destination "C:\TixFlow\wwwroot\web.config" -Force

      - name: 6b. Install Backend Dependencies
        shell: powershell
        run: npm install
        working-directory: C:\TixFlow\ProjectRoot\my-app\backend

      - name: 7. Start Backend Server (Finale Start)
        shell: powershell
        run: |
          $node = $env:NODE_PATH
          if (-not $node) { $node = (Get-Command node).Source }
          $proc = Start-Process -FilePath $node -ArgumentList "index.js" -WorkingDirectory "C:\TixFlow\ProjectRoot\my-app\backend" -NoNewWindow -PassThru
          # Bewaar PID voor gecontroleerde stop bij volgende deploy
          Set-Content -Path "C:\TixFlow\ProjectRoot\backend.pid" -Value $proc.Id
          Write-Host "Backend started. PID: $($proc.Id)"

      - name: 8. Verify Backend Health
        shell: powershell
        run: |
          Start-Sleep -Seconds 3
          try {
            $resp = Invoke-RestMethod -Uri 'http://localhost:5050/api/health' -Method Get -TimeoutSec 5
            Write-Host ($resp | ConvertTo-Json)
          } catch {
            Write-Host "Backend health check failed."
          }