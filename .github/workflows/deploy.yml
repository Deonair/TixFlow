name: TixFlow CI/CD Deployment

on:
  push:
    branches:
      - main  # Start deze workflow bij elke push naar de 'main' branch

jobs:
  deploy:
    runs-on: [self-hosted, Windows, X64]  

    steps:
      - name: 1. Checkout Code and Copy to ProjectRoot ðŸ”„
        # De code wordt nu gekloond naar de tijdelijke map, en direct gekopieerd
        uses: actions/checkout@v4
        
      - name: 1b. Move Code to C:\TixFlow\ProjectRoot ðŸ“‚
        # Verplaats de gekloonde code (alles behalve de tijdelijke .git map) naar ProjectRoot
        run: |
          Remove-Item -Path "C:\TixFlow\ProjectRoot\*" -Recurse -Force -ErrorAction SilentlyContinue
          Copy-Item -Path "${{ github.workspace }}\*" -Destination "C:\TixFlow\ProjectRoot" -Recurse -Force -Exclude .git
        
      - name: 2. Set up Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: '25'
          
      - name: 3. Install Dependencies
        # Voert npm install uit in de ProjectRoot submappen
        run: npm install
        working-directory: C:\TixFlow\ProjectRoot
        
      - name: 4. Build Frontend for Production
        # Voert build uit vanuit de ProjectRoot
        run: npm run build
        working-directory: C:\TixFlow\ProjectRoot
        
      - name: 5. Stop Old Backend Server (Cruciaal voor herstart)
        run: Stop-Process -Name "node" -ErrorAction SilentlyContinue
          
      - name: 6. Copy Frontend Files to IIS Root
        # Kopieert de build-resultaten van ProjectRoot\dist naar wwwroot
        run: |
          Remove-Item -Path "C:\TixFlow\wwwroot\*" -Recurse -Force -ErrorAction SilentlyContinue
          Copy-Item -Path "C:\TixFlow\ProjectRoot\dist\*" -Destination "C:\TixFlow\wwwroot" -Recurse -Force
          
      - name: 7. Start Backend Server (Finale Start)
        # Start de Node.js server vanuit ProjectRoot
        run: Start-Process -FilePath "node" -ArgumentList "backend/server.js", "--port", "5050" -WorkingDirectory "C:\TixFlow\ProjectRoot\my-app\backend" -NoNewWindow
          
      - name: 8. Restart Runner Listener (Runner weer actief maken)
        run: C:\Users\Administrator\actions-runner\run.cmd