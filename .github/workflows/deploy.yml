name: TixFlow CI/CD Deployment

on:
  push:
    branches:
      - main  # Start deze workflow bij elke push naar de 'main' branch

jobs:
  deploy:
    # Dit selecteert de Runner die je net hebt geinstalleerd op Skylab
    runs-on: [self-hosted, Windows, X64]  

    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4
      
      - name: 2. Set up Node.js Environment
        uses: actions/setup-node@v4
        with:
          # Gebruikt Node v25.x, jouw geinstalleerde versie
          node-version: '25' 
          
      - name: 3. Install Dependencies
        run: npm install  
        
      - name: 4. Build Frontend for Production
        # Voert 'npm run build' uit, wat de productiebestanden (de frontend) maakt
        run: npm run build
        
      - name: 5. Stop Old Backend Server (Cruciaal voor herstart)
        # Stopt de Node.js server die op poort 5050 draait.
        # Stop-Process is betrouwbaarder dan NET STOP in dit geautomatiseerde scenario.
        run: Stop-Process -Name "node" -ErrorAction SilentlyContinue
          
      - name: 6. Copy Frontend Files to IIS Root
        # Kopieert de gebuilde React bestanden naar de IIS map die je hebt gekoppeld (C:\TixFlow\wwwroot)
        # Vervang de mapnaam 'dist' als jullie build-map anders heet.
        run: |
          Remove-Item -Path "C:\TixFlow\wwwroot\*" -Recurse -Force -ErrorAction SilentlyContinue
          Copy-Item -Path "./dist/*" -Destination "C:\TixFlow\wwwroot" -Recurse -Force
          
      - name: 7. Start Backend Server (Finale Start)
        # Start de Node.js server op de achtergrond op poort 5050.
        # De vlag -NoNewWindow zorgt ervoor dat de server op de achtergrond blijft draaien.
        run: Start-Process -FilePath "node" -ArgumentList "backend/server.js", "--port", "5050" -WorkingDirectory "backend"
          
      - name: 8. Restart Runner Listener (Runner weer actief maken)
        # Start de Runner Service opnieuw zodat deze weer luistert naar taken (nodig na stap 5 en 7)
        run: .\run.cmd