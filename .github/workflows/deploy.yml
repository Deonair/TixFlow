name: TixFlow CI/CD Deployment

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: [self-hosted, Windows, X64]

    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4
      
      - name: 1b. Move Code to C:\TixFlow\ProjectRoot
        shell: powershell
        run: |
          New-Item -ItemType Directory -Path "C:\TixFlow\ProjectRoot" -ErrorAction SilentlyContinue | Out-Null
          Remove-Item -Path "C:\TixFlow\ProjectRoot\*" -Recurse -Force -ErrorAction SilentlyContinue
          Copy-Item -Path "${{ github.workspace }}\*" -Destination "C:\TixFlow\ProjectRoot" -Recurse -Force

      - name: 2. Set up Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: '25'

      - name: 3. Install Frontend Dependencies
        shell: powershell
        run: npm install
        working-directory: C:\TixFlow\ProjectRoot\my-app

      - name: 4. Build Frontend for Production
        shell: powershell
        run: npm run build
        working-directory: C:\TixFlow\ProjectRoot\my-app

      - name: 5. Stop Old Backend Server (Cruciaal voor herstart)
        run: Stop-Process -Name "node" -ErrorAction SilentlyContinue

      - name: 6. Copy Frontend Files to IIS Root
        shell: powershell
        run: |
          New-Item -ItemType Directory -Path "C:\TixFlow\wwwroot" -ErrorAction SilentlyContinue | Out-Null
          Remove-Item -Path "C:\TixFlow\wwwroot\*" -Recurse -Force -ErrorAction SilentlyContinue
          Copy-Item -Path "C:\TixFlow\ProjectRoot\my-app\dist\*" -Destination "C:\TixFlow\wwwroot" -Recurse -Force

      - name: 6b. Install Backend Dependencies
        shell: powershell
        run: npm install
        working-directory: C:\TixFlow\ProjectRoot\my-app\backend

      - name: 7. Start Backend Server (Finale Start)
        shell: powershell
        run: |
          Start-Process -FilePath "node" -ArgumentList "index.js" -WorkingDirectory "C:\TixFlow\ProjectRoot\my-app\backend" -NoNewWindow